<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM –ì—Ä—É–ø–ø—ã Telegram</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —à—Ä–∏—Ñ—Ç–∞ Inter –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Å—Ç–∏–ª–∏ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --tg-accent: #007AFF; /* –¢–∏–ø–∏—á–Ω—ã–π —Å–∏–Ω–∏–π —Ü–≤–µ—Ç Telegram */
        }
        body {
            font-family: 'Inter', sans-serif;
            /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–π –¥–ª—è Telegram */
            background-color: #1c1c1c; 
            color: #f0f0f0;
        }
        .task-card {
            background-color: #2c2c2e;
            transition: transform 0.15s ease-in-out;
            cursor: pointer;
        }
        .task-card:active {
            transform: scale(0.98);
        }
        .tg-button {
            background-color: var(--tg-accent);
            color: white;
            transition: background-color 0.2s;
        }
        .tg-button:hover {
            background-color: #3b90ff; 
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –≤–≤–æ–¥–∞ –≤ Telegram */
        input[type="text"], textarea, select, input[type="date"] {
            background-color: #3a3a3c;
            border: 1px solid #505050;
            color: #f0f0f0;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ */
        .spinner {
            border-top-color: #007AFF;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner { to { -webkit-transform: rotate(360deg); } }
        @keyframes spinner { to { transform: rotate(360deg); } }
        
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ */
        .status-in_progress { background-color: #3b82f6; } /* Blue - –í —Ä–∞–±–æ—Ç–µ */
        .status-assigned { background-color: #8b5cf6; } /* Indigo - –ù–∞–∑–Ω–∞—á–µ–Ω–∞ */
        .status-on_hold { background-color: #f59e0b; } /* Yellow - –û–∂–∏–¥–∞–µ—Ç */
        .status-done { background-color: #10b981; } /* Green - –ì–æ—Ç–æ–≤–æ */

        .border-high { border-color: #ef4444; } /* Red */
        .border-medium { border-color: #f59e0b; } /* Yellow */
        .border-low { border-color: #10b981; } /* Green */

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–µ—Ç–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ */
        .category-tag {
            background-color: #505050;
            color: #d1d5db;
        }
        
        /* –ê–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä */
        .active-filter {
            background-color: var(--tg-accent) !important;
            color: white !important;
        }
    </style>
</head>
<body class="min-h-screen" onload="initApp()">

    <div id="app" class="max-w-xl mx-auto p-4 space-y-4">
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∞ "–ù–æ–≤–æ–µ –ó–∞–¥–∞–Ω–∏–µ" -->
        <header class="flex justify-between items-center pb-2 border-b border-gray-600">
            <h1 class="text-2xl font-bold">CRM –ì—Ä—É–ø–ø—ã (10 —á–µ–ª.)</h1>
            <button onclick="openModal('newTaskModal')" 
                    class="tg-button px-4 py-2 text-sm font-semibold rounded-lg shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                + –ù–æ–≤–æ–µ –ó–∞–¥–∞–Ω–∏–µ
            </button>
        </header>

        <!-- –§–∏–ª—å—Ç—Ä—ã: –û–±—â–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="space-y-2">
            <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
            <div class="flex">
                <button onclick="resetFilters()" class="px-3 py-1.5 rounded-xl bg-gray-700 text-gray-300 text-sm hover:bg-gray-600 w-full">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</button>
            </div>
             <!-- –§–∏–ª—å—Ç—Ä 1: –°—Ç–∞—Ç—É—Å -->
            <div class="flex space-x-2 p-2 bg-gray-800 rounded-xl shadow-inner text-xs overflow-x-auto" id="statusFilterButtons">
                <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            
             <!-- –§–∏–ª—å—Ç—Ä 2: –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
            <div class="flex space-x-2 p-2 bg-gray-800 rounded-xl shadow-inner text-xs overflow-x-auto" id="categoryFilterButtons">
                <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –ó–∞–¥–∞–Ω–∏–π -->
        <div id="taskList" class="space-y-3">
            <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–¥–∞—á -->
            
            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –∑–∞–¥–∞—á –Ω–µ—Ç -->
            <p id="noTasksMessage" class="text-center text-gray-500 hidden pt-8">
                –ó–∞–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ!
            </p>
        </div>

    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–ù–æ–≤–æ–µ –ó–∞–¥–∞–Ω–∏–µ" -->
    <div id="newTaskModal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm z-50 hidden overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-gray-800 w-full max-w-lg rounded-xl shadow-2xl p-6 space-y-4">
                <h2 class="text-xl font-bold border-b border-gray-700 pb-3">–°–æ–∑–¥–∞—Ç—å –ù–æ–≤–æ–µ –ó–∞–¥–∞–Ω–∏–µ</h2>

                <div class="space-y-4">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ó–∞–¥–∞–Ω–∏—è -->
                    <div>
                        <label for="taskTitle" class="block text-sm font-medium mb-1">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                        <input type="text" id="taskTitle" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"
                               class="w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è (–¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á) -->
                    <div>
                        <label for="taskCategory" class="block text-sm font-medium mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select id="taskCategory" class="w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
                        </select>
                    </div>

                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                    <div>
                        <label for="taskDescription" class="block text-sm font-medium mb-1">–û–ø–∏—Å–∞–Ω–∏–µ / –¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è</label>
                        <textarea id="taskDescription" rows="3" placeholder="–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è..."
                                  class="w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –∏ –î–µ–¥–ª–∞–π–Ω (–≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ) -->
                    <div class="flex space-x-4">
                        <div class="flex-1">
                            <label for="taskAssignee" class="block text-sm font-medium mb-1">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                            <select id="taskAssignee" class="w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞</option>
                                <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ USER_MAP -->
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="taskDeadline" class="block text-sm font-medium mb-1">–î–µ–¥–ª–∞–π–Ω</label>
                            <input type="date" id="taskDeadline" class="w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <!-- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç -->
                    <div>
                        <label class="block text-sm font-medium mb-2">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                        <div class="flex space-x-3">
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="radio" name="priority" value="high" class="form-radio text-red-500">
                                <span class="text-sm">–í—ã—Å–æ–∫–∏–π</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="radio" name="priority" value="medium" class="form-radio text-yellow-500" checked>
                                <span class="text-sm">–°—Ä–µ–¥–Ω–∏–π</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="radio" name="priority" value="low" class="form-radio text-green-500">
                                <span class="text-sm">–ù–∏–∑–∫–∏–π</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="flex justify-end space-x-3 pt-4">
                    <button onclick="closeModal('newTaskModal')" 
                            class="px-4 py-2 text-gray-300 rounded-lg hover:bg-gray-700 focus:outline-none">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button onclick="saveTask()" id="saveTaskButton"
                            class="tg-button px-6 py-2 font-semibold rounded-lg focus:outline-none">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ó–∞–¥–∞–Ω–∏–µ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–î–µ—Ç–∞–ª–∏ –ó–∞–¥–∞–Ω–∏—è" -->
    <div id="taskDetailModal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm z-50 hidden overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-gray-800 w-full max-w-lg rounded-xl shadow-2xl p-6 space-y-4">
                <h2 id="detailTaskTitle" class="text-xl font-bold border-b border-gray-700 pb-3"></h2>

                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                <div class="space-y-2 text-sm text-gray-300">
                    <p><span class="font-semibold text-gray-100">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span> <span id="detailTaskCategory" class="category-tag px-2 py-0.5 rounded-full text-xs font-medium"></span></p>
                    <p><span class="font-semibold text-gray-100">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</span> <span id="detailTaskAssignee"></span></p>
                    <p><span class="font-semibold text-gray-100">–î–µ–¥–ª–∞–π–Ω:</span> <span id="detailTaskDeadline"></span></p>
                    <p><span class="font-semibold text-gray-100">–°—Ç–∞—Ç—É—Å:</span> <span id="detailTaskStatus" class="px-2 py-0.5 rounded-full text-xs text-white font-medium"></span></p>
                </div>
                
                <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                <p id="detailTaskDescription" class="text-gray-200 border-b border-gray-700 pb-4"></p>
                
                <!-- –ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –¥–µ—Ç–∞–ª—å: –°—Å—ã–ª–∫–∏ -->
                <div id="detailTaskLinks" class="text-sm text-gray-400">
                    <!-- –°—Å—ã–ª–∫–∏/–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã –∑–¥–µ—Å—å -->
                </div>


                <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ü—Ä–∞–≤–∫–∏ (–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —á–∞—Å—Ç—å) -->
                <div class="space-y-4">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–∫—Ü–∏–∏ -->
                    <h3 class="text-lg font-semibold text-gray-100">–ò—Å—Ç–æ—Ä–∏—è –∏ –û–±—Å—É–∂–¥–µ–Ω–∏–µ (<span id="commentCount">0</span>)</h3>

                    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
                    <div id="taskCommentsList" class="space-y-3 max-h-48 overflow-y-auto pr-2">
                        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∑–¥–µ—Å—å -->
                    </div>
                    
                    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                    <div class="pt-2">
                        <textarea id="newCommentText" rows="2" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ –≤–Ω–µ—Å—Ç–∏ –ø—Ä–∞–≤–∫—É..."
                                  class="w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                        <div class="flex justify-between items-center mt-2">
                            <label class="flex items-center text-sm text-gray-400 cursor-pointer">
                                <input type="checkbox" id="isRevision" class="mr-2 form-checkbox text-red-500">
                                –í–Ω–µ—Å—Ç–∏ –ø—Ä–∞–≤–∫—É (–û—Ç–º–µ—Ç–∫–∞)
                            </label>
                            <button onclick="addComment(window.currentTaskId)" 
                                    class="tg-button px-4 py-1.5 text-sm rounded-lg">
                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª—è–º–∏ -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-700">
                    <button onclick="closeModal('taskDetailModal')" 
                            class="px-4 py-2 text-gray-300 rounded-lg hover:bg-gray-700 focus:outline-none">
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                    <button onclick="updateTaskStatus(window.currentTaskId, 'done')" id="completeTaskButton"
                            class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg focus:outline-none">
                        –ó–∞–≤–µ—Ä—à–∏—Ç—å –ó–∞–¥–∞—á—É
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –õ–û–ì–ò–ö–ò –ò FIREBASE SETUP -->
    <script type="module">
        // ----------------------------------------------------------------------
        // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firebase –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        // ----------------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, addDoc, updateDoc, arrayUnion, increment, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('Debug'); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        window.userId = 'mockUserId';
        window.currentTasks = {}; // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–¥–∞—á
        window.currentTaskId = null; // ID —Ç–µ–∫—É—â–µ–π –æ—Ç–∫—Ä—ã—Ç–æ–π –∑–∞–¥–∞—á–∏
        window.activeCategoryFilter = 'all'; // –¢–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        window.activeStatusFilter = 'all'; // –¢–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É


        const USER_MAP = {
            'Anrush': { id: 'user_anrush', name: 'Anrush' },
            '–õ–∏–∑–∞': { id: 'user_liza', name: '–õ–∏–∑–∞' },
            '–í–∏–∫—Ç–æ—Ä–∏—è': { id: 'user_viktoria', name: '–í–∏–∫—Ç–æ—Ä–∏—è' },
            '–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫': { id: 'user_nastya', name: '–ù–∞—Å—Ç—è –ö.' },
            '–í–∏–∫—Ç–æ—Ä–∏—è + –õ–∏–∑–∞': { id: 'user_viktoria_liza', name: '–í. + –õ.' },
            '–†—É—Å–ª–∞–Ω': { id: 'user_ruslan', name: '–†—É—Å–ª–∞–Ω' },
            '–ï–ª–∏–∑–∞–≤–µ—Ç–∞': { id: 'user_elizaveta', name: '–ï–ª–∏–∑–∞–≤–µ—Ç–∞' },
            '–õ–∏–∑–∞ + –í–∏–∫—Ç–æ—Ä–∏—è': { id: 'user_liza_viktoria', name: '–õ. + –í.' }, // –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑ –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∏ –†–ö
            'me': { id: 'current_user_id', name: '–Ø' }
        };

        const STATUS_MAP = {
            'üîß –í —Ä–∞–±–æ—Ç–µ': { key: 'in_progress', display: '–í —Ä–∞–±–æ—Ç–µ', class: 'status-in_progress' },
            '‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞': { key: 'assigned', display: '–ù–∞–∑–Ω–∞—á–µ–Ω–∞', class: 'status-assigned' },
            'üü° –û–∂–∏–¥–∞–µ—Ç': { key: 'on_hold', display: '–û–∂–∏–¥–∞–µ—Ç', class: 'status-on_hold' },
            '‚úÖ –ì–æ—Ç–æ–≤–æ': { key: 'done', display: '–ì–æ—Ç–æ–≤–æ', class: 'status-done' },
            'in_progress': { key: 'in_progress', display: '–í —Ä–∞–±–æ—Ç–µ', class: 'status-in_progress' }, // –î–ª—è –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
            'assigned': { key: 'assigned', display: '–ù–∞–∑–Ω–∞—á–µ–Ω–∞', class: 'status-assigned' },
            'on_hold': { key: 'on_hold', display: '–û–∂–∏–¥–∞–µ—Ç', class: 'status-on_hold' },
            'done': { key: 'done', display: '–ì–æ—Ç–æ–≤–æ', class: 'status-done' }
        };

        const PRIORITY_MAP = {
            '–í—ã—Å–æ–∫–∏–π': { key: 'high', display: '–í—ã—Å–æ–∫–∏–π', class: 'border-high' },
            '–°—Ä–µ–¥–Ω–∏–π': { key: 'medium', display: '–°—Ä–µ–¥–Ω–∏–π', class: 'border-medium' },
            '–ù–∏–∑–∫–∏–π': { key: 'low', display: '–ù–∏–∑–∫–∏–π', class: 'border-low' },
            'high': { key: 'high', display: '–í—ã—Å–æ–∫–∏–π', class: 'border-high' }, // –î–ª—è –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
            'medium': { key: 'medium', display: '–°—Ä–µ–¥–Ω–∏–π', class: 'border-medium' },
            'low': { key: 'low', display: '–ù–∏–∑–∫–∏–π', class: 'border-low' }
        };
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ "—Å—ã—Ä—ã—Ö" –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV –≤ —á–∏—Å—Ç—ã–π —Ñ–æ—Ä–º–∞—Ç
        function normalizeTask(task, index) {
            const statusInfo = STATUS_MAP[task.–°—Ç–∞—Ç—É—Å] || STATUS_MAP['assigned'];
            const priorityInfo = PRIORITY_MAP[task.–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç] || PRIORITY_MAP['medium'];
            
            let assigneeKey = task.–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π;
            if (task.–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π) {
                if (task.–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π.includes('+')) {
                    assigneeKey = task.–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π.trim();
                } else if (task.–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π.includes('‚Üí')) {
                     // –£—á–∏—Ç—ã–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç "–í–∏–∫—Ç–æ—Ä–∏—è ‚Üí –õ–∏–∑–∞" –∫–∞–∫ "–õ–∏–∑–∞" (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π)
                    assigneeKey = task.–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π.split('‚Üí').pop().trim(); 
                } else {
                    assigneeKey = task.–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π.trim();
                }
            }
            const assigneeInfo = USER_MAP[assigneeKey] || { id: 'unknown_' + assigneeKey.replace(/\s/g, '_'), name: task.–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω' };

            return {
                id: `csv-task-${index}`,
                title: task.–ó–∞–¥–∞—á–∞,
                category: task.–ö–∞—Ç–µ–≥–æ—Ä–∏—è || '–ü—Ä–æ—á–µ–µ', // –î–æ–±–∞–≤–ª–µ–Ω–æ: –ö–∞—Ç–µ–≥–æ—Ä–∏—è
                author: task.–ê–≤—Ç–æ—Ä,
                assigneeId: assigneeInfo.id,
                assigneeName: assigneeInfo.name,
                deadline: task.–î–µ–¥–ª–∞–π–Ω || null, 
                status: statusInfo.key,
                priority: priorityInfo.key,
                description: task["–ü–æ–¥–∑–∞–¥–∞—á–∏ / –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏"] || task.–ó–∞–¥–∞—á–∞, 
                links: task["–°—Å—ã–ª–∫–∏ / –†–µ—Ñ–µ—Ä–µ–Ω—Å—ã"] || null,
                comments: [], 
                revisionCount: 0, 
                createdAt: new Date(),
                isMock: true
            };
        }

        // --- –î–ê–ù–ù–´–ï –ò–ó CSV (TaskManager - –°–≤–æ–¥–Ω—ã–π.csv) ---
        const RAW_CSV_DATA = `–ö–∞—Ç–µ–≥–æ—Ä–∏—è,–ó–∞–¥–∞—á–∞,–ê–≤—Ç–æ—Ä,–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π,–°—Ç–∞—Ç—É—Å,–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç,–î–µ–¥–ª–∞–π–Ω,–ü–æ–¥–∑–∞–¥–∞—á–∏ / –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏,–°—Å—ã–ª–∫–∏ / –†–µ—Ñ–µ—Ä–µ–Ω—Å—ã
–ò–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞,–°–¥–µ–ª–∞—Ç—å –¢–ó –Ω–∞ –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫—É –¥–ª—è –Ω–∞–±–æ—Ä–∞ ¬´75 —Ñ–æ–∫—É—Å–æ–≤¬ª,–í–∏–∫—Ç–æ—Ä–∏—è,–õ–∏–∑–∞,üîß –í —Ä–∞–±–æ—Ç–µ,–í—ã—Å–æ–∫–∏–π,,–†–∞–±–æ—Ç–∞ –ø–æ –¢–ó; —É—Ç–æ—á–Ω–µ–Ω–∏–µ –æ—Ç –ù–∞—Å—Ç–∏: ¬´—Ä–∞–±–æ—Ç–∞–µ—à—å –ø–æ –¢–ó?¬ª
–ò–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞,–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∏ –≤ —Å—Ç–∏–ª–µ ¬´–ú–∞–π–Ω–∫—Ä–∞—Ñ—Ç¬ª,–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫,–õ–∏–∑–∞,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–°—Ä–µ–¥–Ω–∏–π,,,
–ò–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞,–ò–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –Ω–∞–±–æ—Ä–∞ ¬´–ú–æ–¥–µ–ª—å–µ—Ä¬ª,–í–∏–∫—Ç–æ—Ä–∏—è,–õ–∏–∑–∞,üîß –í —Ä–∞–±–æ—Ç–µ,–í—ã—Å–æ–∫–∏–π,,–õ–∏–∑–∞ —Å–ø—Ä–∞—à–∏–≤–∞–ª–∞ –ø—Ä–æ –¢–ó; –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏ –ø–µ—Ä–µ–¥–∞—Ç—å
–ò–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞,–î–æ–±–∞–≤–∏—Ç—å –∑–Ω–∞—á–æ–∫ ¬´–û—Ä–∏–≥–∏–Ω–∞–ª¬ª –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É,–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫,–õ–∏–∑–∞,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–°—Ä–µ–¥–Ω–∏–π,,,
–ò–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞,–ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫—É/—Å–ª–∞–π–¥—ã –≤ –±–æ–ª–µ–µ —è—Ä–∫–æ–º —Å—Ç–∏–ª–µ,–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫,–õ–∏–∑–∞,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–í—ã—Å–æ–∫–∏–π,,–°–¥–µ–ª–∞—Ç—å –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ –ø–æ —è—Ä–∫–æ—Å—Ç–∏
–ò–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞,"–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ: –£–¢–ü –≤–º–µ—Å—Ç–æ ¬´75 —Ñ–æ–∫—É—Å–æ–≤¬ª, –±–µ–∑ –ø–µ—Ä–µ–≥—Ä—É–∑–∞",–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫,–õ–∏–∑–∞,üü° –û–∂–∏–¥–∞–µ—Ç,–í—ã—Å–æ–∫–∏–π,,"–ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏, –Ω–µ –∞—Ñ–∏—à–∞"
–ò–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞,–ù–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏–π –æ–±–ª–æ–∂–µ–∫ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –í–∏–∫–µ,–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫,–õ–∏–∑–∞,üîß –í —Ä–∞–±–æ—Ç–µ,–í—ã—Å–æ–∫–∏–π,,,
–ö–∞—Ä—Ç–æ—á–∫–∏ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤,–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ 75 –§–æ–∫—É—Å–æ–≤ (–∞–∫—Ü–µ–Ω—Ç –Ω–∞ –£–¢–ü),–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫,–õ–∏–∑–∞,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–í—ã—Å–æ–∫–∏–π,,,
–ö–∞—Ä—Ç–æ—á–∫–∏ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤,–°–¥–µ–ª–∞—Ç—å –±–µ–ª—ã–π —Ñ–æ–Ω –Ω–∞ —Å—Ç–∞—Ä–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ ¬´–ú–æ–¥–µ–ª—å–µ—Ä¬ª –¥–æ –Ω–æ–≤—ã—Ö —Ñ–æ—Ç–æ,–ï–ª–∏–∑–∞–≤–µ—Ç–∞,–õ–∏–∑–∞,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–°—Ä–µ–¥–Ω–∏–π,,,
–ö–∞—Ä—Ç–æ—á–∫–∏ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤,–ù–∞–ø–∏—Å–∞—Ç—å –¢–ó –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É ¬´–î–µ–ª–æ –≤ –®–ª—è–ø–µ¬ª,–†—É—Å–ª–∞–Ω,–í–∏–∫—Ç–æ—Ä–∏—è + –õ–∏–∑–∞,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–í—ã—Å–æ–∫–∏–π,,,
–ö–∞—Ä—Ç–æ—á–∫–∏ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤,–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É 75 –§–æ–∫—É—Å–æ–≤ –ø–æ–¥ ¬´–î–µ–ª–æ –≤ –®–ª—è–ø–µ¬ª,–†—É—Å–ª–∞–Ω,–õ–∏–∑–∞,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–°—Ä–µ–¥–Ω–∏–π,,,
–ö—Ä–µ–∞—Ç–∏–≤—ã –∏ –ö–æ–Ω—Ç–µ–Ω—Ç,–ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å –∫—Ä–µ–∞—Ç–∏–≤—ã –≤ –±–æ–ª–µ–µ —è—Ä–∫–æ–º —Å—Ç–∏–ª–µ,–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫,–õ–∏–∑–∞,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–°—Ä–µ–¥–Ω–∏–π,,,
–ö—Ä–µ–∞—Ç–∏–≤—ã –∏ –ö–æ–Ω—Ç–µ–Ω—Ç,–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –í–∏–∫–µ,–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫,–õ–∏–∑–∞,üîß –í —Ä–∞–±–æ—Ç–µ,–í—ã—Å–æ–∫–∏–π,,,
–ö—Ä–µ–∞—Ç–∏–≤—ã –∏ –ö–æ–Ω—Ç–µ–Ω—Ç,–°–¥–µ–ª–∞—Ç—å –∫—Ä–µ–∞—Ç–∏–≤—ã –≤ —Å—Ç–∏–ª–µ ¬´–ú–∞–π–Ω–∫—Ä–∞—Ñ—Ç¬ª (—Ç–µ—Å—Ç –≥–∏–ø–æ—Ç–µ–∑—ã),–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫,–õ–∏–∑–∞,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–ù–∏–∑–∫–∏–π,,,
–ü–ª–∞–Ω-–§–∞–∫—Ç –∏ –¢–∞–±–ª–∏—Ü—ã,–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–æ–ª–±—Ü—ã ¬´–ú–∞—Ä–∂–∞ –¥–æ –î–†–†¬ª –∏ ¬´–ú–∞—Ä–∂–∞ —Å –î–†–†¬ª,Anrush,Anrush,üîß –í —Ä–∞–±–æ—Ç–µ,–í—ã—Å–æ–∫–∏–π,,,
–ü–ª–∞–Ω-–§–∞–∫—Ç –∏ –¢–∞–±–ª–∏—Ü—ã,–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–æ–ª–±—Ü—ã ¬´–¶–µ–Ω–∞ —Å –°–ü–ü¬ª –∏ ¬´–¶–µ–Ω–∞ –±–µ–∑ –°–ü–ü¬ª,Anrush,Anrush,üîß –í —Ä–∞–±–æ—Ç–µ,–°—Ä–µ–¥–Ω–∏–π,,,
–ü–ª–∞–Ω-–§–∞–∫—Ç –∏ –¢–∞–±–ª–∏—Ü—ã,–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å—ä–µ—Ö–∞–≤—à–∏–µ —è—á–µ–π–∫–∏ –∏ —Ñ–æ—Ä–º—É–ª—ã,Anrush,Anrush,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–í—ã—Å–æ–∫–∏–π,,,
–ü–ª–∞–Ω-–§–∞–∫—Ç –∏ –¢–∞–±–ª–∏—Ü—ã,–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü ABC-–∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ –Ω–∞—á–∞–ª–æ,Anrush,Anrush,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–°—Ä–µ–¥–Ω–∏–π,,,
–ü–ª–∞–Ω-–§–∞–∫—Ç –∏ –¢–∞–±–ª–∏—Ü—ã,–î–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—É—é –º–∞—Ä–∫–∏—Ä–æ–≤–∫—É —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ—Å—Ç–∞–≤–æ–∫ –≤ —Ñ–æ—Ä–º–µ,Anrush,Anrush,üîß –í —Ä–∞–±–æ—Ç–µ,–°—Ä–µ–¥–Ω–∏–π,,,
IT –∏ –ë–æ—Ç—ã –∏ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è,"–£–±—Ä–∞—Ç—å –≤–µ—Ä—Ö–Ω–∏–µ –Ω–µ—Ä–∞–±–æ—á–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏, –æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∏–∂–Ω—é—é",Anrush,Anrush,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–°—Ä–µ–¥–Ω–∏–π,,,
IT –∏ –ë–æ—Ç—ã –∏ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è,–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ WebApp,Anrush,Anrush,üîß –í —Ä–∞–±–æ—Ç–µ,–í—ã—Å–æ–∫–∏–π,,,
IT –∏ –ë–æ—Ç—ã –∏ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è,–ò—Å–ø—Ä–∞–≤–∏—Ç—å ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä¬ª ‚Äî –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å intro,Anrush,Anrush,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–í—ã—Å–æ–∫–∏–π,,,
IT –∏ –ë–æ—Ç—ã –∏ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è,–î–æ–±–∞–≤–∏—Ç—å –º–∏–Ω–∏-–ø—Ä–µ–ª–æ–∞–¥–µ—Ä –ø—Ä–∏ –¥–µ–π—Å—Ç–≤–∏—è—Ö,Anrush,Anrush,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–°—Ä–µ–¥–Ω–∏–π,,,
IT –∏ –ë–æ—Ç—ã –∏ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è,–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å CRM –≤ Telegram-–±–æ—Ç–µ (–∑–∞–¥–∞—á–∏/–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ/—Å—Ä–æ–∫–∏),Anrush,Anrush,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–í—ã—Å–æ–∫–∏–π,,,
–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è –ü–æ–ª–∏–≥—Ä–∞—Ñ–∏—è,–§–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∑–∞–π–Ω –Ω–æ–≤–æ–π –∫–æ—Ä–æ–±–∫–∏,–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫,–í–∏–∫—Ç–æ—Ä–∏—è + –õ–∏–∑–∞,üîß –í —Ä–∞–±–æ—Ç–µ,–í—ã—Å–æ–∫–∏–π,,,
–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è –ü–æ–ª–∏–≥—Ä–∞—Ñ–∏—è,–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ñ–æ—Ç–æ –Ω–æ–≤–æ–π –∫–æ—Ä–æ–±–∫–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫/–∫—Ä–µ–∞—Ç–∏–≤–æ–≤,–õ–∏–∑–∞,–õ–∏–∑–∞,üü° –û–∂–∏–¥–∞–µ—Ç,–°—Ä–µ–¥–Ω–∏–π,,,
–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è –ü–æ–ª–∏–≥—Ä–∞—Ñ–∏—è,–£—Ç–æ—á–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–¥–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å–æ—Å—Ç–∞–≤ –Ω–∞–±–æ—Ä–∞ –ú–∞—à–µ,–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫,–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫,üîß –í —Ä–∞–±–æ—Ç–µ,–í—ã—Å–æ–∫–∏–π,,,
–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∏ –†–ö,–°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω –∑–∞–ø—É—Å–∫–∞ —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏ –ø–æ —ç—Ç–∞–ø–∞–º,–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫,–í–∏–∫—Ç–æ—Ä–∏—è,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–í—ã—Å–æ–∫–∏–π,,,
–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∏ –†–ö,–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å A/B —Ç–µ—Å—Ç –æ–±–ª–æ–∂–µ–∫,–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫,–õ–∏–∑–∞ + –í–∏–∫—Ç–æ—Ä–∏—è,üü° –û–∂–∏–¥–∞–µ—Ç,–í—ã—Å–æ–∫–∏–π,,,
–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∏ –†–ö,–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å 2‚Äì3 —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –£–¢–ü –≤ –†–ö,–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫,–í–∏–∫—Ç–æ—Ä–∏—è,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–°—Ä–µ–¥–Ω–∏–π,,,
–ü—Ä–æ—á–∏–µ –∑–∞–¥–∞—á–∏,–°–¥–µ–ª–∞—Ç—å –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫—É –≤—Ç–æ—Ä–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ —Å—Ç–∏–ª–µ –ø–µ—Ä–≤–æ–π,Anrush,–õ–∏–∑–∞,‚≠ï –ù–∞–∑–Ω–∞—á–µ–Ω–∞,–°—Ä–µ–¥–Ω–∏–π,,,
–ü—Ä–æ—á–∏–µ –∑–∞–¥–∞—á–∏,–ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è embed-–∫–æ–¥–æ–≤ Kinescope –ø–æ API,Anrush,Anrush,‚úÖ –ì–æ—Ç–æ–≤–æ,–ù–∏–∑–∫–∏–π,,,
`;

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –±–æ–ª–µ–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å —É—á–µ—Ç–æ–º –∫–∞–≤—ã—á–µ–∫
                const values = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);

                if (!values) continue; 

                const cleanedValues = values.map(v => {
                    v = v.replace(/^"|"$/g, '').trim(); 
                    return v;
                });

                if (cleanedValues.length === headers.length) {
                    let item = {};
                    headers.forEach((header, index) => {
                        item[header] = cleanedValues[index];
                    });
                    data.push(normalizeTask(item, i));
                } else {
                    console.warn("Skipping row due to incorrect column count:", lines[i]);
                }
            }
            return data;
        }

        const initialMockTasks = parseCSV(RAW_CSV_DATA);


        function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken)
                        .then((userCredential) => {
                            window.userId = userCredential.user.uid;
                            console.log("Authenticated successfully with custom token.");
                            startDataListeners();
                        })
                        .catch((error) => {
                            console.error("Custom token sign-in failed. Signing in anonymously:", error);
                            signInAnonymously(auth).then(() => { 
                                window.userId = auth.currentUser.uid; 
                                console.log("Signed in anonymously.");
                                startDataListeners();
                            });
                        });
                } else {
                    signInAnonymously(auth).then(() => { 
                        window.userId = auth.currentUser.uid; 
                        console.log("Signed in anonymously.");
                        startDataListeners();
                    });
                }
            } catch (e) {
                console.error("Firebase initialization failed. Using mock data only.", e);
                // –ï—Å–ª–∏ Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –º–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                window.currentTasks = initialMockTasks.reduce((acc, task) => {
                    acc[task.id] = task;
                    return acc;
                }, {});
                renderTasks();
                populateAssigneeDropdown();
                populateCategoryDropdown(initialMockTasks);
            }
        }

        window.getTasksCollectionRef = () => {
            return collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
        };

        function startDataListeners() {
            // –ú–æ–∫–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            window.currentTasks = initialMockTasks.reduce((acc, task) => {
                acc[task.id] = task;
                return acc;
            }, {});
            renderTasks();
            populateAssigneeDropdown();
            populateCategoryDropdown(initialMockTasks);
        }
        
        window.initApp = () => {
            initFirebase();
        };
        
        // ----------------------------------------------------------------------
        // 2. –õ–æ–≥–∏–∫–∞ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∏ UI
        // ----------------------------------------------------------------------

        function renderTasks() {
            const taskList = document.getElementById('taskList');
            const tasksArray = Object.values(window.currentTasks);
            
            const filteredTasks = tasksArray.filter(task => {
                // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
                let statusMatch = true;
                if (window.activeStatusFilter === 'pending') {
                    statusMatch = task.status !== 'done';
                } else if (window.activeStatusFilter === 'overdue') {
                    const deadlineDate = task.deadline ? new Date(task.deadline) : null;
                    statusMatch = task.status !== 'done' && deadlineDate && deadlineDate < new Date();
                } else if (window.activeStatusFilter !== 'all') {
                    statusMatch = task.status === window.activeStatusFilter;
                }
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                let categoryMatch = true;
                if (window.activeCategoryFilter !== 'all') {
                    categoryMatch = task.category === window.activeCategoryFilter;
                }
                
                return statusMatch && categoryMatch;
            });

            if (filteredTasks.length === 0) {
                taskList.innerHTML = `<p class="text-center text-gray-500 pt-8">
                    –ù–µ—Ç –∑–∞–¥–∞—á –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.
                </p>`;
                return;
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            updateFilterCounts(tasksArray);
            
            taskList.innerHTML = filteredTasks.map(task => {
                const priorityInfo = PRIORITY_MAP[task.priority] || PRIORITY_MAP.medium;
                const statusInfo = STATUS_MAP[task.status] || STATUS_MAP.assigned;
                const deadlineDate = task.deadline ? new Date(task.deadline) : null;
                const isOverdue = deadlineDate && task.status !== 'done' && deadlineDate < new Date();
                
                return `
                    <div class="task-card p-4 rounded-xl shadow-lg border-l-4 ${priorityInfo.class}" onclick="openModal('taskDetailModal', '${task.id}')">
                        <div class="flex justify-between items-start mb-2">
                            <h2 class="text-lg font-semibold truncate pr-4">${task.title}</h2>
                            <span class="text-xs font-bold text-gray-300 bg-gray-700/50 px-2 py-0.5 rounded-full">${priorityInfo.display}</span>
                        </div>
                        
                        <div class="flex items-center space-x-3 text-sm mb-2 text-gray-400">
                            <!-- –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å -->
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1 text-blue-400"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                <span>${task.assigneeName}</span>
                            </div>
                            <!-- –î–µ–¥–ª–∞–π–Ω -->
                            <div class="flex items-center font-medium ${isOverdue ? 'text-red-500' : 'text-yellow-400'}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                <span>${task.deadline ? task.deadline : '–ù–µ—Ç —Å—Ä–æ–∫–∞'} ${isOverdue ? '(–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ)' : ''}</span>
                            </div>
                        </div>
                        
                        <!-- –°—Ç–∞—Ç—É—Å –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è -->
                        <div class="flex justify-between items-center text-xs pt-1 border-t border-gray-700 mt-1">
                            <span class="text-white px-2 py-0.5 rounded-full font-medium ${statusInfo.class}">${statusInfo.display}</span>
                            <span class="category-tag px-2 py-0.5 rounded-full font-medium">${task.category}</span>
                            <span class="text-gray-400">–ö–æ–º–º.: ${task.comments ? task.comments.length : 0} | –ü—Ä–∞–≤–∫–∏: ${task.revisionCount || 0}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // --- –õ–æ–≥–∏–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ ---
        window.resetFilters = () => {
            window.activeStatusFilter = 'all';
            window.activeCategoryFilter = 'all';
            renderTasks();
        };

        // --- –õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É ---
        window.filterTasks = (filterKey) => {
            window.activeStatusFilter = filterKey;
            
            document.querySelectorAll('#statusFilterButtons button').forEach(btn => {
                btn.classList.remove('active-filter');
            });

            const currentButton = document.getElementById(`filter-status-${filterKey}`);
            if(currentButton) {
                currentButton.classList.add('active-filter');
            }
            
            renderTasks();
        };

        // --- –õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º ---
        window.filterByCategory = (category) => {
            window.activeCategoryFilter = category;
            
            document.querySelectorAll('#categoryFilterButtons button').forEach(btn => {
                btn.classList.remove('active-filter');
            });

            const currentButton = document.getElementById(`filter-category-${category}`);
            if(currentButton) {
                currentButton.classList.add('active-filter');
            }
            
            renderTasks();
        };
        
        function updateFilterCounts(tasks) {
            const counts = { all: tasks.length, in_progress: 0, assigned: 0, on_hold: 0, done: 0, overdue: 0, pending: 0 };
            const today = new Date();

            tasks.forEach(task => {
                counts[task.status] = (counts[task.status] || 0) + 1;
                if (task.status !== 'done') {
                    counts.pending++;
                    const deadlineDate = task.deadline ? new Date(task.deadline) : null;
                    if (deadlineDate && deadlineDate < today) {
                        counts.overdue++;
                    }
                }
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —Å—Ç–∞—Ç—É—Å–∞
            const filterContainer = document.getElementById('statusFilterButtons');
            filterContainer.innerHTML = `
                <button id="filter-status-all" class="px-3 py-1.5 rounded-full bg-gray-600 hover:bg-gray-500 text-gray-200 ${window.activeStatusFilter === 'all' ? 'active-filter' : ''}" onclick="filterTasks('all')">–í—Å–µ (${counts.all})</button>
                <button id="filter-status-in_progress" class="px-3 py-1.5 rounded-full bg-gray-600 hover:bg-gray-500 text-gray-200 ${window.activeStatusFilter === 'in_progress' ? 'active-filter' : ''}" onclick="filterTasks('in_progress')">${STATUS_MAP.in_progress.display} (${counts.in_progress})</button>
                <button id="filter-status-assigned" class="px-3 py-1.5 rounded-full bg-gray-600 hover:bg-gray-500 text-gray-200 ${window.activeStatusFilter === 'assigned' ? 'active-filter' : ''}" onclick="filterTasks('assigned')">${STATUS_MAP.assigned.display} (${counts.assigned})</button>
                <button id="filter-status-on_hold" class="px-3 py-1.5 rounded-full bg-gray-600 hover:bg-gray-500 text-gray-200 ${window.activeStatusFilter === 'on_hold' ? 'active-filter' : ''}" onclick="filterTasks('on_hold')">${STATUS_MAP.on_hold.display} (${counts.on_hold})</button>
                <button id="filter-status-done" class="px-3 py-1.5 rounded-full bg-gray-600 hover:bg-gray-500 text-gray-200 ${window.activeStatusFilter === 'done' ? 'active-filter' : ''}" onclick="filterTasks('done')">${STATUS_MAP.done.display} (${counts.done})</button>
                <button id="filter-status-overdue" class="px-3 py-1.5 rounded-full ${counts.overdue > 0 || window.activeStatusFilter === 'overdue' ? 'bg-red-600 text-white' : 'bg-gray-600 hover:bg-red-500 text-white font-medium'} ${window.activeStatusFilter === 'overdue' ? 'active-filter' : ''}" onclick="filterTasks('overdue')">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ (${counts.overdue})</button>
            `;
            
            // –ï—Å–ª–∏ "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ" –∞–∫—Ç–∏–≤–Ω–æ, –Ω–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å, —É–±–∏—Ä–∞–µ–º —Å–∏–Ω–∏–π –∞–∫—Ü–µ–Ω—Ç, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–Ω—ã–π
            const overdueBtn = document.getElementById('filter-status-overdue');
            if(window.activeStatusFilter === 'overdue' && overdueBtn && counts.overdue === 0) {
                overdueBtn.classList.remove('active-filter');
            }
        }
        
        function populateAssigneeDropdown() {
            const select = document.getElementById('taskAssignee');
            select.innerHTML = '<option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞</option>';
            
            Object.keys(USER_MAP).filter(key => key !== 'me').forEach(key => {
                const user = USER_MAP[key];
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                select.appendChild(option);
            });
        }

        function populateCategoryDropdown(tasks) {
            const select = document.getElementById('taskCategory');
            select.innerHTML = '<option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
            const uniqueCategories = new Set(tasks.map(t => t.category).filter(c => c));

            const categoryFilterContainer = document.getElementById('categoryFilterButtons');
            categoryFilterContainer.innerHTML = `
                 <button id="filter-category-all" class="px-3 py-1.5 rounded-full bg-gray-600 hover:bg-gray-500 text-gray-200 ${window.activeCategoryFilter === 'all' ? 'active-filter' : ''}" onclick="filterByCategory('all')">–í—Å–µ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
            `;

            uniqueCategories.forEach(category => {
                // –î–ª—è —Ñ–æ—Ä–º—ã
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
                
                // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
                const button = document.createElement('button');
                button.id = `filter-category-${category}`;
                button.className = `px-3 py-1.5 rounded-full bg-gray-600 hover:bg-gray-500 text-gray-200 ${window.activeCategoryFilter === category ? 'active-filter' : ''}`;
                button.textContent = category;
                button.onclick = () => filterByCategory(category);
                categoryFilterContainer.appendChild(button);
            });
        }


        window.openModal = (id, taskId = null) => {
            window.currentTaskId = taskId;
            document.getElementById(id).classList.remove('hidden');

            if (id === 'taskDetailModal' && taskId) {
                const task = window.currentTasks[taskId];
                if (!task) {
                    // –≠—Ç–æ –±—ã–ª–∞ –≥–ª–∞–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏. –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–æ.
                    console.error("Task not found with ID:", taskId);
                    closeModal(id);
                    return;
                }
                
                const statusInfo = STATUS_MAP[task.status] || STATUS_MAP.assigned;
                
                document.getElementById('detailTaskTitle').textContent = task.title;
                document.getElementById('detailTaskTitle').classList.remove('border-high', 'border-medium', 'border-low');
                document.getElementById('detailTaskTitle').classList.add(PRIORITY_MAP[task.priority].class);
                
                document.getElementById('detailTaskCategory').textContent = task.category || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'; // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                document.getElementById('detailTaskAssignee').textContent = task.assigneeName;
                document.getElementById('detailTaskDeadline').textContent = task.deadline || '–°—Ä–æ–∫ –Ω–µ —É–∫–∞–∑–∞–Ω';
                
                const statusSpan = document.getElementById('detailTaskStatus');
                statusSpan.textContent = statusInfo.display;
                statusSpan.className = `px-2 py-0.5 rounded-full text-xs text-white font-medium ${statusInfo.class}`;
                
                document.getElementById('detailTaskDescription').textContent = task.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.';
                
                const linksHtml = task.links ? 
                    `<span class="font-semibold text-gray-100">–°—Å—ã–ª–∫–∏:</span> <a href="${task.links}" target="_blank" class="text-blue-400 underline">${task.links}</a>` :
                    '<span class="text-gray-500 italic">–°—Å—ã–ª–æ–∫ –Ω–µ—Ç.</span>';
                document.getElementById('detailTaskLinks').innerHTML = linksHtml;

                renderComments(task);
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–≤–µ—Ä—à–∏—Ç—å", –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
                document.getElementById('completeTaskButton').style.display = task.status === 'done' ? 'none' : 'inline-block';
            }
        };

        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
            window.currentTaskId = null;
        };

        function renderComments(task) {
            const commentsList = document.getElementById('taskCommentsList');
            const commentCount = document.getElementById('commentCount');
            
            const comments = task.comments || [];
            
            if (comments.length === 0) {
                commentsList.innerHTML = '<p class="text-gray-500 italic text-sm text-center">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
                commentCount.textContent = '0';
                return;
            }
            
            commentsList.innerHTML = comments.map(comment => {
                const isRevision = comment.isRevision;
                // –í –º–æ–∫–æ–≤–æ–º —Ä–µ–∂–∏–º–µ userId –±—É–¥–µ—Ç 'mockUserId', –ø–æ—ç—Ç–æ–º—É –∏—â–µ–º –ø–æ userName –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
                const userName = comment.userName || Object.values(USER_MAP).find(u => u.id === comment.userId)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
                const time = comment.timestamp instanceof Date ? comment.timestamp.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="bg-gray-700 p-3 rounded-lg text-sm ${isRevision ? 'border-l-4 border-red-500' : ''}">
                        <p class="font-medium ${isRevision ? 'text-red-400' : 'text-blue-400'}">${userName} <span class="text-xs text-gray-500"> (${time})</span></p>
                        <p class="text-gray-300">${comment.text}</p>
                        ${isRevision ? '<span class="block text-xs text-gray-400 mt-1 italic">‚Äî –≠—Ç–æ –æ—Ç–º–µ—Ç–∫–∞ –æ –≤–Ω–µ—Å–µ–Ω–∏–∏ –ø—Ä–∞–≤–∫–∏.</span>' : ''}
                    </div>
                `;
            }).join('');
            
            commentCount.textContent = comments.length;
            
            setTimeout(() => {
                commentsList.scrollTop = commentsList.scrollHeight;
            }, 0);
        }

        window.saveTask = async () => {
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const category = document.getElementById('taskCategory').value;
            const assigneeId = document.getElementById('taskAssignee').value;
            const deadline = document.getElementById('taskDeadline').value;
            const priority = document.querySelector('input[name="priority"]:checked').value;
            
            if (!title || !assigneeId || !deadline || !category) {
                console.error('Validation failed: Title, Category, Assignee, and Deadline are required.');
                return;
            }

            const button = document.getElementById('saveTaskButton');
            button.disabled = true;
            button.innerHTML = '<div class="spinner border-4 border-t-4 border-gray-400 border-opacity-25 h-5 w-5 rounded-full inline-block mr-2"></div> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

            try {
                const assigneeName = Object.values(USER_MAP).find(u => u.id === assigneeId)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';

                const newTaskData = {
                    title: title,
                    description: description,
                    category: category,
                    assigneeId: assigneeId,
                    assigneeName: assigneeName,
                    deadline: deadline,
                    priority: priority,
                    status: 'assigned',
                    createdAt: serverTimestamp() || new Date(),
                    createdBy: window.userId,
                    comments: [],
                    revisionCount: 0
                };
                
                if (db) {
                    const docRef = await addDoc(window.getTasksCollectionRef(), newTaskData);
                    console.log("Document written with ID: ", docRef.id);
                } else {
                    const mockId = 'new-task-' + Date.now();
                    window.currentTasks[mockId] = { ...newTaskData, id: mockId, isMock: false, createdAt: new Date(), isMock: true };
                    renderTasks();
                    // –ü–µ—Ä–µ–∑–∞–ø–æ–ª–Ω–∏–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞
                    populateCategoryDropdown(Object.values(window.currentTasks));
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                closeModal('newTaskModal');
                // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskDescription').value = '';
                document.getElementById('taskCategory').value = '';
                document.getElementById('taskAssignee').value = '';
                document.getElementById('taskDeadline').value = '';
                document.querySelector('input[name="priority"][value="medium"]').checked = true;


            } catch (e) {
                console.error("Error saving task:", e);
            } finally {
                button.disabled = false;
                button.innerHTML = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ó–∞–¥–∞–Ω–∏–µ';
            }
        };

        window.addComment = async (taskId) => {
             const commentText = document.getElementById('newCommentText').value.trim();
             const isRevision = document.getElementById('isRevision').checked;
             
             if (!commentText || !taskId) return;
             
             const currentUserName = Object.values(USER_MAP).find(u => u.id === window.userId)?.name || '–Ø (–°–æ–∑–¥–∞—Ç–µ–ª—å)';

             const newComment = {
                text: commentText,
                userId: window.userId,
                userName: currentUserName,
                timestamp: serverTimestamp() || new Date(),
                isRevision: isRevision
             };

             const task = window.currentTasks[taskId];
             
             if (db && !task.isMock) {
                 const docRef = doc(window.getTasksCollectionRef(), taskId);
                 await updateDoc(docRef, {
                     comments: arrayUnion(newComment),
                     revisionCount: isRevision ? increment(1) : task.revisionCount
                 });
             } else {
                 task.comments = [...(task.comments || []), newComment];
                 if (isRevision) task.revisionCount = (task.revisionCount || 0) + 1;
                 renderComments(task);
                 renderTasks();
             }
             
             document.getElementById('newCommentText').value = '';
             document.getElementById('isRevision').checked = false;
        };

        window.updateTaskStatus = async (taskId, newStatus) => {
            const task = window.currentTasks[taskId];
            if (!task) return;

            if (db && !task.isMock) {
                const docRef = doc(window.getTasksCollectionRef(), taskId);
                await updateDoc(docRef, { status: newStatus });
            } else {
                task.status = newStatus;
                renderTasks();
                closeModal('taskDetailModal');
            }
        };

    </script>
</body>
</html>
