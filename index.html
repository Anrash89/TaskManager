<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CRM –¥–ª—è Telegram-–≥—Ä—É–ø–ø—ã (10 —á–µ–ª.)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
  :root { --tg-accent:#007AFF; }
  body{ font-family:Inter,system-ui,-apple-system,Segoe UI; background:#1c1c1c; color:#f0f0f0;}
  .card{ background:#2c2c2e; border:1px solid #3b3b3b; }
  .chip{ background:#505050; color:#e5e7eb; }
  .tg-btn{ background:var(--tg-accent); color:#fff; }
  .tg-btn:hover{ background:#3b90ff;}
  .task:hover{ transform:translateY(-1px)}
  .status-in_progress{ background:#3b82f6 }
  .status-assigned{ background:#8b5cf6 }
  .status-on_hold{ background:#f59e0b }
  .status-done{ background:#10b981 }
  .border-high{ border-left:4px solid #ef4444 }
  .border-medium{ border-left:4px solid #f59e0b }
  .border-low{ border-left:4px solid #10b981 }
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.65); backdrop-filter: blur(4px); z-index:50; }
  .hidden{ display:none }
  .input, select, textarea{ background:#323235; border:1px solid #4a4a4f; border-radius:.6rem; padding:.6rem .8rem; color:#f0f0f0; width:100% }
  .spinner{ border:3px solid rgba(255,255,255,.15); border-top-color:#007AFF; border-radius:9999px; width:18px;height:18px; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle }
  @keyframes spin{to{transform:rotate(360deg)}}
  .active-filter{ background:var(--tg-accent) !important; color:#fff !important;}
</style>
</head>
<body class="min-h-screen">

<!-- –•–µ–¥–µ—Ä -->
<header class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
  <h1 class="text-xl sm:text-2xl font-bold">CRM –∫–æ–º–∞–Ω–¥—ã (10 —á–µ–ª.)</h1>
  <div class="flex gap-2">
    <button id="btnImportSheet" class="tg-btn px-3 py-2 rounded-lg text-sm">–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã</button>
    <button id="btnNew" class="tg-btn px-3 py-2 rounded-lg text-sm">+ –ù–æ–≤–∞—è</button>
  </div>
</header>

<!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
<section class="max-w-4xl mx-auto px-4 space-y-2">
  <div class="card rounded-xl p-3 flex gap-2 flex-wrap items-center">
    <button id="resetFilters" class="px-3 py-2 rounded-lg bg-gray-700 text-sm">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
    <div class="ml-auto flex gap-2">
      <button id="btnExportCSV" class="px-3 py-2 rounded-lg bg-gray-700 text-sm">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      <label class="px-3 py-2 rounded-lg bg-gray-700 text-sm cursor-pointer">
        –ò–º–ø–æ—Ä—Ç CSV<input id="importCsvInput" type="file" accept=".csv" class="hidden">
      </label>
    </div>
  </div>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="grid md:grid-cols-2 gap-2">
    <div id="statusFilters" class="card rounded-xl p-2 flex gap-2 overflow-x-auto"></div>
    <div id="categoryFilters" class="card rounded-xl p-2 flex gap-2 overflow-x-auto"></div>
  </div>
</section>

<!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
<main class="max-w-4xl mx-auto px-4 py-4" id="taskList">
  <p class="text-center text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>
</main>

<!-- –ú–æ–¥–∞–ª–∫–∞: –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ -->
<div id="modalNew" class="modal hidden">
  <div class="min-h-full flex items-center justify-center p-4">
    <div class="card w-full max-w-xl rounded-xl p-5 space-y-4">
      <h2 class="text-lg font-semibold">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
      <div class="grid sm:grid-cols-2 gap-3">
        <div class="sm:col-span-2">
          <label class="text-sm text-gray-300">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
          <input id="fTitle" class="input" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ">
        </div>
        <div>
          <label class="text-sm text-gray-300">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <input id="fCategory" class="input" placeholder="–ù–∞–ø—Ä.: –ò–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞">
        </div>
        <div>
          <label class="text-sm text-gray-300">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
          <select id="fAssignee" class="input"></select>
        </div>
        <div>
          <label class="text-sm text-gray-300">–î–µ–¥–ª–∞–π–Ω</label>
          <input id="fDeadline" type="date" class="input">
        </div>
        <div>
          <label class="text-sm text-gray-300">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
          <select id="fPriority" class="input">
            <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
            <option value="high">–í—ã—Å–æ–∫–∏–π</option>
            <option value="low">–ù–∏–∑–∫–∏–π</option>
          </select>
        </div>
        <div class="sm:col-span-2">
          <label class="text-sm text-gray-300">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="fDescription" rows="3" class="input"></textarea>
        </div>
        <div class="sm:col-span-2">
          <label class="text-sm text-gray-300">–°—Å—ã–ª–∫–∏</label>
          <input id="fLinks" class="input" placeholder="https://‚Ä¶">
        </div>
      </div>
      <div class="flex justify-end gap-2">
        <button class="px-4 py-2 rounded-lg bg-gray-700" onclick="closeNew()">–û—Ç–º–µ–Ω–∞</button>
        <button id="btnSaveNew" class="tg-btn px-4 py-2 rounded-lg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞: –¥–µ—Ç–∞–ª–∏ -->
<div id="modalDetail" class="modal hidden">
  <div class="min-h-full flex items-center justify-center p-4">
    <div class="card w-full max-w-xl rounded-xl p-5 space-y-4">
      <div class="flex items-start justify-between gap-3">
        <h2 id="dTitle" class="text-lg font-semibold"></h2>
        <span id="dPriority" class="text-xs px-2 py-1 rounded-full chip"></span>
      </div>

      <div class="grid sm:grid-cols-2 gap-2 text-sm">
        <div><span class="text-gray-400">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span> <span id="dCategory" class="chip px-2 py-0.5 rounded-full"></span></div>
        <div><span class="text-gray-400">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</span> <span id="dAssignee"></span></div>
        <div><span class="text-gray-400">–î–µ–¥–ª–∞–π–Ω:</span> <span id="dDeadline"></span></div>
        <div><span class="text-gray-400">–°—Ç–∞—Ç—É—Å:</span> <span id="dStatus" class="px-2 py-0.5 rounded-full text-white text-xs"></span></div>
      </div>

      <p id="dDesc" class="text-sm text-gray-200"></p>
      <div id="dLinks" class="text-sm text-blue-300"></div>

      <hr class="border-gray-700">
      <div>
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">–ò—Å—Ç–æ—Ä–∏—è –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ <span id="dCommentCount" class="text-gray-400">(0)</span></h3>
          <div class="flex gap-2">
            <button id="btnMarkDone" class="px-3 py-1.5 rounded-lg bg-green-600 hover:bg-green-700 text-sm">–û—Ç–º–µ—Ç–∏—Ç—å ¬´–ì–æ—Ç–æ–≤–æ¬ª</button>
            <button id="btnCloseDetail" class="px-3 py-1.5 rounded-lg bg-gray-700 text-sm">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
        <div id="dComments" class="space-y-2 max-h-48 overflow-y-auto pr-1"></div>
        <div class="mt-2">
          <textarea id="fComment" rows="2" class="input" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ –ø—Ä–∞–≤–∫–∞‚Ä¶"></textarea>
          <div class="flex justify-between items-center mt-2">
            <label class="text-sm text-gray-300 flex items-center gap-2">
              <input id="fIsRevision" type="checkbox"> –≠—Ç–æ –ø—Ä–∞–≤–∫–∞
            </label>
            <button id="btnAddComment" class="tg-btn px-3 py-1.5 rounded-lg text-sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* ===================== –ù–ê–°–¢–†–û–ô–ö–ò ===================== */
// 1) –í—Å—Ç–∞–≤—å —Å—é–¥–∞ CSV-—Å—Å—ã–ª–∫—É –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–π Google Sheets:
// –§–æ—Ä–º–∞—Ç: https://docs.google.com/spreadsheets/d/<SHEET_ID>/export?format=csv&gid=<GID>
const SHEET_CSV_URL = "1wK7fBKISWNR-yl_7Odw9UG7l9zW3d_R_1FY67gYhIVI";

// 2) –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥—ã (–≤–∏–¥–∏–º—ã–µ –∏–º–µ–Ω–∞)
const USER_MAP = [
  "–ò–ª—å—è","–õ–∏–∑–∞","–í–∏–∫—Ç–æ—Ä–∏—è","–ù–∞—Å—Ç—è –ö—Ä–µ–ø–∞–∫","–ï–ª–∏–∑–∞–≤–µ—Ç–∞","–†—É—Å–ª–∞–Ω",
  "–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞","–õ–∏–∑–∞ + –í–∏–∫—Ç–æ—Ä–∏—è"
];

/* ===================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ï ===================== */
const STATUS = {
  in_progress:{ key:"in_progress", title:"–í —Ä–∞–±–æ—Ç–µ", cls:"status-in_progress"},
  assigned:{ key:"assigned", title:"–ù–∞–∑–Ω–∞—á–µ–Ω–∞", cls:"status-assigned"},
  on_hold:{ key:"on_hold", title:"–û–∂–∏–¥–∞–µ—Ç", cls:"status-on_hold"},
  done:{ key:"done", title:"–ì–æ—Ç–æ–≤–æ", cls:"status-done"}
};
const PRIORITY = {
  high:  { key:"high",   title:"–í—ã—Å–æ–∫–∏–π", cls:"border-high" },
  medium:{ key:"medium", title:"–°—Ä–µ–¥–Ω–∏–π", cls:"border-medium" },
  low:   { key:"low",    title:"–ù–∏–∑–∫–∏–π",  cls:"border-low" }
};

let tasks = {};            // { id: Task }
let activeStatus = "all";  // —Ñ–∏–ª—å—Ç—Ä
let activeCategory = "all";
let currentId = null;      // –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞

const byId = (id)=>document.getElementById(id);
const uid = ()=>"t_"+Math.random().toString(36).slice(2,10);
const todayISO = ()=>new Date().toISOString().slice(0,10);

function saveLocal(){
  localStorage.setItem("crm_tasks", JSON.stringify(tasks));
}
function loadLocal(){
  try{
    const raw = localStorage.getItem("crm_tasks");
    tasks = raw ? JSON.parse(raw) : {};
  }catch(e){ tasks = {}; }
}

/* ===================== TELEGRAM MINI APP ===================== */
let tg = null;
(function initTelegram(){
  if (window.Telegram && window.Telegram.WebApp){
    tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();
    tg.enableClosingConfirmation();
    tg.MainButton.setText("–°–≤–µ—Ä–Ω—É—Ç—å");
    tg.MainButton.onClick(()=>tg.close());
    tg.MainButton.show();
  }
})();

/* ===================== CSV PARSER ===================== */
/* –£—Å—Ç–æ–π—á–∏–≤—ã–π –∫ –∫–∞–≤—ã—á–∫–∞–º –∏ –∑–∞–ø—è—Ç—ã–º –≤ —è—á–µ–π–∫–∞—Ö */
function parseCSV(text){
  const rows = [];
  let i=0, cur="", row=[], inQuotes=false;
  while(i<text.length){
    const ch = text[i];
    if (ch === '"'){
      if (inQuotes && text[i+1] === '"'){ cur+='"'; i+=2; continue; }
      inQuotes = !inQuotes; i++; continue;
    }
    if (!inQuotes && (ch === ',')){
      row.push(cur); cur=""; i++; continue;
    }
    if (!inQuotes && (ch === '\n' || ch === '\r')){
      if (cur.length || row.length){ row.push(cur); rows.push(row); row=[]; cur=""; }
      // eat \r\n
      if (ch === '\r' && text[i+1]==='\n') i+=2; else i++;
      continue;
    }
    cur+=ch; i++;
  }
  if (cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows;
}

/* –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º CSV (—Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏):
   –ö–∞—Ç–µ–≥–æ—Ä–∏—è,–ó–∞–¥–∞—á–∞,–ê–≤—Ç–æ—Ä,–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π,–°—Ç–∞—Ç—É—Å,–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç,–î–µ–¥–ª–∞–π–Ω,–ü–æ–¥–∑–∞–¥–∞—á–∏ / –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏,–°—Å—ã–ª–∫–∏ / –†–µ—Ñ–µ—Ä–µ–Ω—Å—ã
*/
function csvRowsToTasks(rows){
  if (!rows.length) return {};
  const header = rows[0].map(h=>h.trim());
  const idx = (name)=> header.findIndex(h=>h.toLowerCase()===name.toLowerCase());
  const col = {
    category: idx("–ö–∞—Ç–µ–≥–æ—Ä–∏—è"),
    title: idx("–ó–∞–¥–∞—á–∞"),
    author: idx("–ê–≤—Ç–æ—Ä"),
    assignee: idx("–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π"),
    status: idx("–°—Ç–∞—Ç—É—Å"),
    priority: idx("–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç"),
    deadline: idx("–î–µ–¥–ª–∞–π–Ω"),
    desc: idx("–ü–æ–¥–∑–∞–¥–∞—á–∏ / –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏"),
    links: idx("–°—Å—ã–ª–∫–∏ / –†–µ—Ñ–µ—Ä–µ–Ω—Å—ã"),
  };
  const out = {};
  for(let r=1;r<rows.length;r++){
    const line = rows[r];
    if (!line || !line.length) continue;
    const title = (line[col.title]||"").trim();
    if (!title) continue;
    const rawStatus = (line[col.status]||"").trim();
    let status = "assigned";
    // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —ç–º–æ–¥–∑–∏-—Å—Ç–∞—Ç—É—Å–æ–≤ –∏–∑ —Ç–≤–æ–µ–≥–æ CSV
    if (/–≤ —Ä–∞–±–æ—Ç–µ|üîß/i.test(rawStatus)) status="in_progress";
    else if (/–æ–∂–∏–¥–∞–µ—Ç|üü°/i.test(rawStatus)) status="on_hold";
    else if (/–≥–æ—Ç–æ–≤–æ|‚úÖ/i.test(rawStatus)) status="done";
    else if (/–Ω–∞–∑–Ω–∞—á–µ–Ω–∞|‚≠ï/i.test(rawStatus)) status="assigned";

    const pr = (line[col.priority]||"").toLowerCase();
    const priority = /–≤—ã—Å–æ–∫/i.test(pr) ? "high" : /–Ω–∏–∑–∫/i.test(pr) ? "low" : "medium";

    const assigneeRaw = (line[col.assignee]||"").trim();
    let assignee = assigneeRaw;
    if (assignee.includes("‚Üí")) assignee = assignee.split("‚Üí").pop().trim();

    const id = uid();
    out[id] = {
      id,
      title,
      category: (line[col.category]||"–ü—Ä–æ—á–µ–µ").trim(),
      author: (line[col.author]||"").trim(),
      assigneeName: assignee || "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω",
      deadline: (line[col.deadline]||"").trim(),
      status,
      priority,
      description: (line[col.desc]||"").trim(),
      links: (line[col.links]||"").trim(),
      comments: [],
      revisionCount: 0,
      createdAt: Date.now()
    };
  }
  return out;
}

/* ===================== UI –†–ï–ù–î–ï–† ===================== */
function renderFilters(){
  const list = Object.values(tasks);
  // —Å—Ç–∞—Ç—É—Å—ã
  const counts = { all:list.length, in_progress:0, assigned:0, on_hold:0, done:0, overdue:0 };
  const cats = new Set();
  const now = new Date();

  for (const t of list){
    counts[t.status] = (counts[t.status]||0)+1;
    if (t.category) cats.add(t.category);
    if (t.status !== "done" && t.deadline){
      const d = new Date(t.deadline);
      if (!isNaN(d) && d < now) counts.overdue++;
    }
  }

  const s = byId("statusFilters");
  s.innerHTML = "";
  const mkBtn=(key,label,bg="bg-gray-700")=>{
    const b=document.createElement("button");
    b.className = `px-3 py-1.5 rounded-full text-sm ${bg} ${activeStatus===key?"active-filter":""}`;
    b.textContent = `${label}`;
    b.onclick = ()=>{ activeStatus=key; renderTasks(); renderFilters(); };
    s.appendChild(b);
  };
  mkBtn("all", `–í—Å–µ (${counts.all})`);
  mkBtn("in_progress", `${STATUS.in_progress.title} (${counts.in_progress})`);
  mkBtn("assigned", `${STATUS.assigned.title} (${counts.assigned})`);
  mkBtn("on_hold", `${STATUS.on_hold.title} (${counts.on_hold})`);
  mkBtn("done", `${STATUS.done.title} (${counts.done})`);
  mkBtn("overdue", `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ (${counts.overdue})`, counts.overdue>0?"bg-red-600":"bg-gray-700");

  const c = byId("categoryFilters");
  c.innerHTML = "";
  const allC=document.createElement("button");
  allC.className=`px-3 py-1.5 rounded-full text-sm bg-gray-700 ${activeCategory==="all"?"active-filter":""}`;
  allC.textContent="–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏";
  allC.onclick=()=>{ activeCategory="all"; renderTasks(); renderFilters(); };
  c.appendChild(allC);
  [...cats].sort().forEach(cat=>{
    const b=document.createElement("button");
    b.className=`px-3 py-1.5 rounded-full text-sm bg-gray-700 ${activeCategory===cat?"active-filter":""}`;
    b.textContent=cat;
    b.onclick=()=>{ activeCategory=cat; renderTasks(); renderFilters(); };
    c.appendChild(b);
  });
}

function renderTasks(){
  const wrap = byId("taskList");
  const list = Object.values(tasks);
  const now = new Date();

  let filtered = list.filter(t=>{
    let ok = true;
    if (activeStatus==="overdue"){
      ok = t.status!=="done" && t.deadline && new Date(t.deadline) < now;
    } else if (activeStatus!=="all"){
      ok = t.status===activeStatus;
    }
    if (ok && activeCategory!=="all"){
      ok = t.category === activeCategory;
    }
    return ok;
  });

  if (!filtered.length){
    wrap.innerHTML = `<p class="text-center text-gray-400 pt-8">–ù–µ—Ç –∑–∞–¥–∞—á –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º.</p>`;
    return;
  }

  wrap.innerHTML = filtered.map(t=>{
    const pr = PRIORITY[t.priority]||PRIORITY.medium;
    const st = STATUS[t.status]||STATUS.assigned;
    const overdue = t.deadline && t.status!=="done" && new Date(t.deadline) < now;
    return `
      <div class="card task rounded-xl p-4 mb-3 transition border ${pr.cls}" data-id="${t.id}">
        <div class="flex items-start justify-between gap-3">
          <h3 class="text-base font-semibold pr-2">${escapeHtml(t.title)}</h3>
          <span class="text-xs chip px-2 py-0.5 rounded-full">${pr.title}</span>
        </div>
        <div class="mt-2 text-sm flex flex-wrap gap-x-4 gap-y-1 text-gray-300">
          <div>üë§ ${escapeHtml(t.assigneeName||"–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω")}</div>
          <div class="${overdue?'text-red-400':'text-yellow-300'}">‚è∞ ${t.deadline||'–ù–µ—Ç —Å—Ä–æ–∫–∞'} ${overdue?'(–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ)':''}</div>
        </div>
        <div class="mt-2 flex items-center justify-between text-xs">
          <span class="px-2 py-0.5 rounded-full text-white ${st.cls}">${st.title}</span>
          <span class="chip px-2 py-0.5 rounded-full">${escapeHtml(t.category||"–ü—Ä–æ—á–µ–µ")}</span>
          <span class="text-gray-400">–ö–æ–º–º.: ${(t.comments||[]).length} | –ü—Ä–∞–≤–∫–∏: ${t.revisionCount||0}</span>
        </div>
      </div>
    `;
  }).join("");

  // –∫–ª–∏–∫–∏
  wrap.querySelectorAll(".task").forEach(el=>{
    el.addEventListener("click", ()=> openDetail(el.dataset.id));
  });
}

function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

/* ===================== –î–ï–¢–ê–õ–ò + –ö–û–ú–ú–ï–ù–¢–´ ===================== */
function openDetail(id){
  currentId = id;
  const t = tasks[id]; if (!t) return;
  byId("dTitle").textContent = t.title;
  byId("dPriority").textContent = (PRIORITY[t.priority]||PRIORITY.medium).title;
  byId("dCategory").textContent = t.category||"–ü—Ä–æ—á–µ–µ";
  byId("dAssignee").textContent = t.assigneeName||"–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
  byId("dDeadline").textContent = t.deadline||"–°—Ä–æ–∫ –Ω–µ —É–∫–∞–∑–∞–Ω";
  const st = STATUS[t.status]||STATUS.assigned;
  const stEl = byId("dStatus");
  stEl.textContent = st.title;
  stEl.className = `px-2 py-0.5 rounded-full text-white text-xs ${st.cls}`;
  byId("dDesc").textContent = t.description||"";
  byId("dLinks").innerHTML = t.links ? `<a class="underline" href="${t.links}" target="_blank">${t.links}</a>` : `<span class="text-gray-400">–°—Å—ã–ª–æ–∫ –Ω–µ—Ç</span>`;
  renderComments();
  byId("modalDetail").classList.remove("hidden");
}

function closeDetail(){
  byId("modalDetail").classList.add("hidden");
  currentId=null;
}

function renderComments(){
  const t = tasks[currentId]; if (!t) return;
  const list = t.comments||[];
  byId("dCommentCount").textContent = `(${list.length})`;
  const box = byId("dComments");
  if (!list.length){
    box.innerHTML = `<p class="text-gray-400 text-sm italic">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>`;
    return;
  }
  box.innerHTML = list.map(c=>{
    const when = new Date(c.ts||Date.now()).toLocaleString("ru-RU",{hour:"2-digit",minute:"2-digit", day:"2-digit", month:"2-digit"});
    return `
      <div class="bg-gray-700/70 p-2 rounded-lg text-sm ${c.revision?'border-l-4 border-red-500':''}">
        <p class="${c.revision?'text-red-300':'text-blue-300'} font-medium">${escapeHtml(c.user||"–Ø")} <span class="text-gray-400 text-xs">(${when})</span></p>
        <p class="text-gray-100">${escapeHtml(c.text)}</p>
        ${c.revision?'<p class="text-gray-400 text-xs italic mt-1">‚Äî –æ—Ç–º–µ—Ç–∫–∞ –æ –ø—Ä–∞–≤–∫–µ</p>':''}
      </div>
    `;
  }).join("");
  // –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
  setTimeout(()=>{ box.scrollTop = box.scrollHeight; },0);
}

byId("btnAddComment").onclick = ()=>{
  const t = tasks[currentId]; if (!t) return;
  const text = byId("fComment").value.trim();
  if (!text) return;
  const revision = byId("fIsRevision").checked;
  t.comments = [...(t.comments||[]), { text, revision, ts: Date.now(), user:"–Ø" }];
  if (revision) t.revisionCount = (t.revisionCount||0)+1;
  byId("fComment").value = ""; byId("fIsRevision").checked=false;
  saveLocal();
  renderComments(); renderTasks();
  if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
};

byId("btnMarkDone").onclick = ()=>{
  const t = tasks[currentId]; if (!t) return;
  t.status = "done";
  saveLocal();
  renderTasks();
  openDetail(currentId); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
};

byId("btnCloseDetail").onclick = closeDetail;

/* ===================== –ù–û–í–ê–Ø –ó–ê–î–ê–ß–ê ===================== */
function openNew(){
  fillAssignees();
  byId("modalNew").classList.remove("hidden");
}
function closeNew(){ byId("modalNew").classList.add("hidden"); }

function fillAssignees(){
  const s = byId("fAssignee");
  s.innerHTML = `<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞</option>` + USER_MAP.map(n=>`<option>${n}</option>`).join("");
}

byId("btnNew").onclick = openNew;
byId("btnSaveNew").onclick = ()=>{
  const title = byId("fTitle").value.trim();
  const category = byId("fCategory").value.trim() || "–ü—Ä–æ—á–µ–µ";
  const assigneeName = byId("fAssignee").value.trim() || "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
  const deadline = byId("fDeadline").value || "";
  const priority = byId("fPriority").value || "medium";
  const description = byId("fDescription").value.trim();
  const links = byId("fLinks").value.trim();

  if (!title){
    alert("–ó–∞–ø–æ–ª–Ω–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫"); return;
  }
  const id = uid();
  tasks[id] = {
    id, title, category, assigneeName, deadline, priority,
    status:"assigned", description, links, comments:[], revisionCount:0, createdAt: Date.now()
  };
  saveLocal();
  closeNew();
  // –æ—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
  ["fTitle","fCategory","fAssignee","fDeadline","fDescription","fLinks"].forEach(id=>byId(id).value="");
  byId("fPriority").value="medium";
  renderFilters(); renderTasks();
  if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred("success");
};

/* ===================== CSV –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø ===================== */
async function fetchSheetCSV(){
  if (!SHEET_CSV_URL || SHEET_CSV_URL.startsWith("PASTE_")){
    alert("–£–∫–∞–∂–∏ —Å—Å—ã–ª–∫—É CSV –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–π Google-—Ç–∞–±–ª–∏—Ü—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π SHEET_CSV_URL.");
    return;
  }
  const btn = byId("btnImportSheet");
  const old = btn.innerHTML;
  btn.innerHTML = `<span class="spinner"></span> –ò–º–ø–æ—Ä—Ç‚Ä¶`; btn.disabled=true;
  try{
    const res = await fetch(SHEET_CSV_URL, { cache:"no-store" });
    const txt = await res.text();
    const rows = parseCSV(txt);
    const imported = csvRowsToTasks(rows);
    // –ú—è–≥–∫–∏–π –º—ë—Ä–¥–∂: –æ–±–Ω–æ–≤–ª—è–µ–º/–¥–æ–±–∞–≤–ª—è–µ–º –ø–æ title+assignee+deadline (–≥—Ä—É–±—ã–π –∫–ª—é—á)
    const keyOf = (t)=>[t.title,t.assigneeName,t.deadline].join("|").toLowerCase();
    const index = {};
    Object.values(tasks).forEach(t=> index[keyOf(t)] = t.id);
    for (const t of Object.values(imported)){
      const k = keyOf(t);
      if (index[k]) {
        const id = index[k];
        tasks[id] = { ...tasks[id], ...t, id };
      } else {
        tasks[t.id] = t;
      }
    }
    saveLocal();
    renderFilters(); renderTasks();
  }catch(e){
    console.error(e);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å CSV –∏–∑ Google Sheets.");
  }finally{
    btn.innerHTML = old; btn.disabled=false;
  }
}

function tasksToCSV(){
  const header = ["–ö–∞—Ç–µ–≥–æ—Ä–∏—è","–ó–∞–¥–∞—á–∞","–ê–≤—Ç–æ—Ä","–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π","–°—Ç–∞—Ç—É—Å","–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç","–î–µ–¥–ª–∞–π–Ω","–ü–æ–¥–∑–∞–¥–∞—á–∏ / –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏","–°—Å—ã–ª–∫–∏ / –†–µ—Ñ–µ—Ä–µ–Ω—Å—ã"];
  const lines = [header.join(",")];
  for (const t of Object.values(tasks)){
    const row = [
      t.category||"", t.title||"", t.author||"", t.assigneeName||"", (STATUS[t.status]?.title||""),
      (PRIORITY[t.priority]?.title||""), t.deadline||"", t.description||"", t.links||""
    ].map(cell=>{
      const s = (cell||"").replace(/"/g,'""');
      return /[",\n\r]/.test(s) ? `"${s}"` : s;
    });
    lines.push(row.join(","));
  }
  return lines.join("\r\n");
}

function download(filename, text){
  const a=document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text],{type:"text/csv;charset=utf-8"}));
  a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
}

byId("btnExportCSV").onclick = ()=> download(`crm_export_${todayISO()}.csv`, tasksToCSV());

byId("importCsvInput").addEventListener("change", async (e)=>{
  const file = e.target.files[0]; if (!file) return;
  const text = await file.text();
  const rows = parseCSV(text);
  const imported = csvRowsToTasks(rows);
  // –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º
  tasks = { ...tasks, ...imported };
  saveLocal();
  renderFilters(); renderTasks();
  e.target.value = "";
});

/* ===================== –°–ë–†–û–° –§–ò–õ–¨–¢–†–û–í –ò –ö–ù–û–ü–ö–ò ===================== */
byId("resetFilters").onclick = ()=>{ activeStatus="all"; activeCategory="all"; renderFilters(); renderTasks(); };
byId("btnImportSheet").onclick = fetchSheetCSV;

/* ===================== –°–¢–ê–†–¢ ===================== */
function init(){
  loadLocal();
  renderFilters();
  renderTasks();
}
init();

/* ===================== –ö–õ–û–£–ñ–ï–†–´ –î–õ–Ø –ú–û–î–ê–õ–û–ö ===================== */
window.openDetail = openDetail;
window.closeDetail = closeDetail;
window.closeNew = closeNew;
/* ===================== –ö–û–ù–ï–¶ ===================== */
</script>
</body>
</html>
